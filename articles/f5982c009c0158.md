---
title: "Partedit ã§ Neovim LSP ãŒèµ·å‹•ã—ãªã„"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - vim
  - neovim
  - lsp
published: true
published_at: "2025-07-25 06:00"
---

# ç¾è±¡

Markdown ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé¡ãªã©ã€éƒ¨åˆ†çš„ã«ä»–ã®è¨€èªãŒæ··ã˜ã‚‹æ–‡æ›¸ã‚’ Vim ã§ç·¨é›†ã™ã‚‹éš›ã¯ [`thinca/vim-partedit`](https://github.com/thinca/vim-partedit) ãŒä¾¿åˆ©ã§ã™ã€‚ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã€ç¯„å›²é¸æŠã—ãŸä¸Šã§ `:Partedit` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã®å†…å®¹ãŒåˆ¥ãƒãƒƒãƒ•ã‚¡ã¨ã—ã¦åˆ‡ã‚Šå‡ºã•ã‚Œã¾ã™ã€‚ãã†ã™ã‚‹ã“ã¨ã§ã€éƒ¨åˆ†çš„ã«åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã§ç·¨é›†ã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ä¿å­˜æ“ä½œã‚’ã™ã‚‹ã¨ `BufWriteCmd` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã•ã‚Œã‚‹ã¨ã„ã†ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚

Neovim ã«ã¯çµ„ã¿è¾¼ã¿ã® LSP æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€ä¸Šè¿°ã® Partedit ã«ã‚ˆã‚‹ãƒãƒƒãƒ•ã‚¡å†…ã«ã¦èµ·å‹•ã—ã¦ã»ã—ã„ LSP ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„ã¨ã„ã†å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã¯è£œå®Œãªã©ãŒå…¨ãåŠ¹ã‹ãšæœ¬æœ«è»¢å€’ã§ã™ã€‚


# ç’°å¢ƒ

- Neovim (v0.11.3)
- [`thinca/vim-partedit`](https://github.com/thinca/vim-partedit) (a4ed06ff)
- lua-language-server (3.15.0)
- ãã®ä»–è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
  - [`nvim/init.lua`](https://github.com/gw31415/zenn-example-partedit-nvim-lsp/blob/main/nvim/init.lua)
  - [`nvim/lsp/lua_ls.lua`](https://github.com/gw31415/zenn-example-partedit-nvim-lsp/blob/main/nvim/lsp/lua_ls.lua) (`nvim-lspconfig` ã®ã‚‚ã®ã¨åŒä¸€)

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«æœ€å°æ§‹æˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

https://github.com/gw31415/zenn-example-partedit-nvim-lsp

# æ‰‹é †

ä»¥ä¸‹ã®3ã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦è©²å½“ãƒãƒƒãƒ•ã‚¡ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸ LSP ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

1. å®Ÿåœ¨ã™ã‚‹ Lua ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†
2. å®Ÿåœ¨ã™ã‚‹ Lua ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Partedit ã§é–‹ã„ãŸã‚‚ã®
3. åˆæœŸèµ·å‹•æ™‚ã®ç©ºãƒãƒƒãƒ•ã‚¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ `lua` ã«ã—ãŸã‚‚ã®

ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸ LSP ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã§ã™ã€‚

```vim
:lua= vim.lsp.get_clients { bufnr = 0 }
```

## Case 1. å®Ÿåœ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

lua-language-server ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã®ã§ã€é©å½“ãª Lua ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¨ LSP ã‚µãƒ¼ãƒãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã‚‹ç­ˆã§ã™ã€‚ä¸åº¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒ Lua ãƒ•ã‚¡ã‚¤ãƒ«ãªã®ã§é–‹ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
nvim nvim/init.lua
```

ãã—ã¦ `:lua= vim.lsp.get_clients { bufnr = 0 }` ã§ãƒã‚§ãƒƒã‚¯ã€‚

![Luaã®å‡ºåŠ›(1)](/images/f5982c009c0158/lua-output-case1.png)

ãã¡ã‚“ã¨èµ·å‹•ã—ã¦ã„ã¾ã™ã­ã€‚

## Case 2. Partedit ã§èµ·å‹•ã—ãŸãƒãƒƒãƒ•ã‚¡

ãã‚Œã§ã¯ãã®ã¾ã¾ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒƒãƒ•ã‚¡å…¨ä½“ã‚’ Partedit ã«ã¶ã¡è¾¼ã¿ã¾ã—ã‚‡ã†ã€‚

```vim
:%Partedit -filetype lua
```

ãã—ã¦ `:lua= vim.lsp.get_clients { bufnr = 0 }` ã§ãƒã‚§ãƒƒã‚¯ã€‚

![Luaã®å‡ºåŠ›(2)](/images/f5982c009c0158/lua-output-case2.png)

ä½•ã‚‚ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¾ã›ã‚“ã€‚ã¡ãªã¿ã«ã€æ‰‹å‹•ã§ `:lua vim.lsp.enable 'lua_ls'` ã‚’æ‰“ã¡ã“ã‚“ã å¾Œã‚‚åŒæ§˜ã®çµæœã§ã—ãŸã€‚

## Case 3. `ft=lua` ã®ç©ºãƒãƒƒãƒ•ã‚¡

æ°—ã‚’å–ã‚Šç›´ã—ã¦ã€åˆæœŸèµ·å‹•ã®ãƒãƒƒãƒ•ã‚¡ã«å¯¾ã—ã¦ `:set ft=lua` ã—ã¦ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```vim
" å¼•æ•°ãªã—ã§ nvim ã—ãŸå¾Œ
:set ft=lua
:lua= vim.lsp.get_clients { bufnr = 0 }
```

![Luaã®å‡ºåŠ›(3)](/images/f5982c009c0158/lua-output-case3.png)

ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã¾ã—ãŸï¼

# çµå±€åŸå› ã¯ä½•ãªã®ã‹

Case 3. ã§å®Ÿåœ¨ã—ãªã„ãƒãƒƒãƒ•ã‚¡ã«å¯¾ã—ã¦ã‚‚ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãŸã®ã§ã€å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿåœ¨ã¯é–¢ä¿‚ãªã„ã‚ˆã†ã§ã™ã€‚

å…ˆã«çµè«–ã‚’è¨€ã†ã¨ã€**åŸå› ã¯ `buftype` ã®å€¤ã«ã‚ã‚Šã¾ã™**ã€‚ Case 2.ã«å¯¾ã—ã¦ `:set bt=''` ã‚’ã—ãŸå¾Œã« LSP ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã¨é©åˆ‡ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¾ã™ã€‚

```vim
" Parteditã®ãƒãƒƒãƒ•ã‚¡ã§ã‚‚å¤§ä¸ˆå¤«ãªãƒ‘ã‚¿ãƒ¼ãƒ³
:%Partedit -filetype lua
:set bt=''
:lua vim.lsp.enable 'lua_ls'
:lua= vim.lsp.get_clients { bufnr = 0 }
```

ç¾åœ¨ã® Neovim LSP ã®å®Ÿè£…ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ä½•æ•…ã‹ **`buftype` ãŒç©ºã§ãªã„ã¨ã‚¢ã‚¿ãƒƒãƒã§ããªã„** ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰ã™ã‚‹å‡¦ç†ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/neovim/neovim/blob/db1542af3d03d304738fa22c1c848c2f02c37156/runtime/lua/vim/lsp.lua#L533-L538

> Only ever attach to buffers that represent an actual file.

ã¨ã‚ã‚‹ã‚ˆã†ã«ã€è‡ªå‹•èµ·å‹•å‡¦ç†ãŒå„ç¨®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œæˆã—ãŸãƒãƒƒãƒ•ã‚¡ã«å¯¾ã—ã¦èª¤çˆ†ã™ã‚‹ã“ã¨ã‚’å›é¿ã™ã‚‹ãŸã‚ã«æŒ¿å…¥ã•ã‚ŒãŸå‡¦ç†ã§ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

å®Ÿéš›ã€ä»Šå›æ¤œè¨¼ã—ãŸ3ã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã® `buftype` ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

| Case | `buftype` |
|------|---------|
| Case1. å®Ÿåœ¨Luaãƒ•ã‚¡ã‚¤ãƒ« | (ç©º) |
| Case2. Parteditãƒãƒƒãƒ•ã‚¡ | `acwrite` |
| Case3. åˆæœŸç©ºãƒãƒƒãƒ•ã‚¡ | (ç©º) |


# å›é¿æ³•

æš«å®šçš„ã«ã€è‡ªèº«ã¯ [`thinca/vim-partedit`](https://github.com/thinca/vim-partedit) ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã•ã›ã¦ã„ãŸã ãã€ãƒãƒƒãƒ•ã‚¡ã« `acwrite` ã‚’ä»˜åŠ ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§å¯¾å‡¦ã—ã¦ã„ã¾ã™ã€‚

https://github.com/gw31415/vim-partedit/commit/dbb7f08999088a60961af51b0ef607975ccc9172

```diff vim
--- a/autoload/partedit.vim
+++ b/autoload/partedit.vim
@@ -77,7 +77,9 @@ function! partedit#start(startline, endline, ...)
   let b:partedit__contents = original_contents
   let b:partedit__prefix = prefix
   let b:partedit__bufhidden = bufhidden
-  setlocal buftype=acwrite nomodified bufhidden=wipe noswapfile
+  " NOTE(gw31415): Delete acwrite: because Neovim LSP does not start
+  " Reference: https://github.com/neovim/neovim/blob/d4c8e8df1c80cf195dc1d1b98c1c8429dd3f43ed/runtime/lua/vim/lsp.lua#L535-L537
+  setlocal nomodified bufhidden=wipe noswapfile
 
   command! -buffer -bar ParteditEnd execute b:partedit__bufnr 'buffer'
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ¬ä½“ã«æ‰‹ã‚’åŠ ãˆã‚‹ç‚¹ã§ã‹ãªã‚Šç„¡ç†çŸ¢ç†ãªæ°—ã‚‚ã—ã¾ã™ãŒã€ã“ã¡ã‚‰ã§æ­£å¸¸ã« `:Partedit` ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

æã‚‰ãæ‰‹å‹•ã§ `vim.lsp.start()` ã™ã‚‹ã®ãŒæ­£æ”»æ³•ã§ã™ãŒã€ `vim.lsp.enable()` ã¨åŒæ§˜ã®èµ·å‹•æ¡ä»¶ã‚’æ›¸ãç¾½ç›®ã«ãªã‚Šãã†ã ã£ãŸã®ã§ä¸­æ–­ã—ã¾ã—ãŸã€‚
