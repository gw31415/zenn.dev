---
title: TOMLで簡単に書けるMake風タスクランナーを作った
type: tech
topics:
  - make
  - just
  - task
  - rust
emoji: ⚙️
published: true
---
実は1年塩漬けにしていたプロジェクトです

![最後のコミット](/images/52ba37bde76980/last-commits.webp)
*つつがなくご無沙汰の最終コミットたち*

# きっかけ

ご存知のとおり、Make はタスクランナーとしてかなりの重鎮です。個人的にファイルの `mtime` を読んで適宜タスクをスキップするというアイデアが好きでお気に入りでした。ただ、Make は辛いところもありました。Make を使ったことがある人は `.PHONY` や `Makefile` の辛さを知っていると思います。Make の辛みは**痒いところに手が届かないような辛み**かなと感じます。例えば以下のようなことが挙げられます。

- `.PHONY` の記述が辛い
  - ほとんどの人はMakeをプロジェクトローカル便利コマンドショートカットのように使うので、ほとんど全てのタスクで `.PHONY` を使うことになります。
- `Makefile` の文法が辛い
  - 特にハードタブやインデントの扱いです
  - 自身は[ハードタブ比較的好き](https://github.com/gw31415/dotfiles/blob/643cf6ae5fd92bc7ffc742cac751cc133a82c64a/.editorconfig#L3-L5)なので一般の人よりは抵抗感が少ないですが、強制されるのは違和感があります。
- 他ディレクトリにある設定を読み込む時に辛い
  - 確か `include` と相対パスの解決周りで辛かった記憶があります
- `CC` などの隠れ変数が辛い
  - 特定の言語に依存しているので、使わなければ便利機能を把握するきっかけが少ない
- (簡単に)非同期実行したい
  - ~~作った当初は~~ `-j` ~~オプションを知りませんでした~~
  - それでも、デフォルト並列で良いと思いました(強引ですみません)

## 閃いたアイデア

ある時、`.PHONY` 問題を解決する自分なりのアイデアを思いつきました。

> 毎度 `.PHONY` を書くのが面倒なわけだから、命名規則で解決できないか？

ということで、以下のルールを考えました。

1. `.` **or** `/` **が含まれていたらファイル**とみなす
2. **英数字と** `_` **のみで構成されているなら** `PHONY` とみなす

:::message
2に関しては未来の開発時の拡張性を考慮して厳しめにしています
:::

これが初めのアイデアで、前述の問題を解決していこうと開発を始めました。

# 作ったもの

こちらです。Rust 製の Task ランナーということで `rusk` と命名しました (Rust 製を売りにしたいわけではないですが)。

https://github.com/gw31415/rusk-task

~~1年塩漬けしただけあって~~、安定していると思います。

インストールは `cargo install` でできます。

```bash
cargo install rusk-task
```

## 使い方

タスクリストを [規定の形式](https://github.com/gw31415/rusk-task/blob/main/example/rusk.toml) でTOMLに記述・配置し、同一または上位のディレクトリから `rusk` コマンドを叩きます。

```bash
rusk <タスク名>...
```

タスクを省略するとアクセス可能なタスク一覧が出力されます。

### 設定ファイルの文法

ファイルの形式は TOML で、名前は `rusk.toml` または `*.rusk.toml` とします。以下はサンプルです。

https://github.com/gw31415/rusk-task/blob/8aa1e7fb1d748d820707e5fbf3229d387410cc58/example/rusk.toml

`tasks.{名前}` にタスクを定義していきます。タスクのプロパティは以下の通りです。

| プロパティ | 説明 | 
| --- | --- | 
| `description` | タスクの説明です。記載すると `rusk` の引数なし実行で説明が表示されます | 
| `script` | 実行するシェルスクリプトです。文字列で指定できます | 
| `depends` | 依存するタスクの Array です | 

全てのプロパティは任意です。

## 売り

売りは前述の命名規則によるものを代表に以下のようなものがあります。

### 1. 命名規則によるターゲットの分岐(ファイル / `PHONY`)

ターゲットに関するルールを再掲します。

1. `.` **or** `/` **が含まれていたらファイル**とみなす
  - もし `.` や `/` が含まれないファイルの場合、`./` を行頭に付与して明示できます
  - 例: `Makefile` → `./Makefile`
2. **英数字と** `_` **のみで構成されているなら** `PHONY` とみなす

ファイルの場合は `mtime` を見て適宜実行をスキップし、 `PHONY` の場合は必ず実行します

### 2. オプションなし実行でタスクリストを出力

`rusk` を引数なしで実行すると以下のような出力が得られます。

![タスクリストの出力](/images/52ba37bde76980/task-list.webp)
*タスクリストの出力*

そう、タスクの一覧が出力されます。タスクと説明がタブ区切りで出力されています。シェルがインタラクティブでない場合は色なしなので、補完などでも利用できます。

:::details 実際にこの出力を利用してシェル用補完スクリプトを作成しています

#### Bash の補完スクリプト

https://github.com/gw31415/rusk-task/blob/8aa1e7fb1d748d820707e5fbf3229d387410cc58/completions/rusk.bash

#### fish の補完スクリプト

https://github.com/gw31415/rusk-task/blob/8aa1e7fb1d748d820707e5fbf3229d387410cc58/completions/rusk.fish

:::

### 3. カレントディレクトリ以下の設定ファイルの探索

お察しのとおり、`rusk` はカレントディレクトリ以下にある設定ファイルを探索します。

:::message
子孫ディレクトリの設定ファイルに記載されたファイルターゲットに関しては、**設定ファイルに記載通りの文字列ではなく現在のディレクトリからの相対パスとして指定**します。
:::

### 4. `deno_task_shell` によるクロスプラットフォーム対応

`deno_task_shell` は `deno task` や `dax` の内部で利用されているクロスプラットフォーム利用を意識して開発されたシェルで、Windowsなどにおいても Unix のパイプやリダイレクトが利用できるようになっています。

`rusk` における `script` の解釈にはこちらを用いています。

### N. その他

- いい感じ(筆者の好み)に相対パス解決
  - タスクの `cwd` はデフォルトで `rusk.toml` の配置されたディレクトリです
  - ファイルターゲットの指定は現在のディレクトリからの相対パスです
- 兄弟タスクはデフォルトで並行に処理します

# 開発の思い出

## 棲み分け

**やっていることは車輪の再発明激戦区**なので、開発のモチベ維持に他のツールにないコンセプトを考えました。同じようなプロジェクトには以下のようなものがあります。

- [Make](https://www.gnu.org/software/make/)
- [cargo-make](https://sagiegurari.github.io/cargo-make/)
- [just](https://just.systems)
- [task](https://taskfile.dev)

沢山ありますね……。1つ1つの特徴を挙げていきながら分析しました。

- Make
  - 元祖
  - このプロジェクトのきっかけ
- cargo-make
  - 高機能タスクランナー
  - プラグイン・外部 crate を利用可能
  - 引数付きタスク、依存関係、条件分岐に対応
  - Rust プロジェクトでの開発を意識している節があり、Cargo と強く結合したデフォルト設定がある
- just
  - 軽量なタスクランナー（ビルドシステムではない）
  - Makefile 互換思想だが独自で簡潔な構文
  - 引数付きタスクが書ける
  - mtime などによる自動タスクスキップ機能は見つからなかった
- task
  - YAML で記載する
  - 動作指定部分に長いスクリプトは書きづらい
  - 依存関係・条件実行・並列実行をサポート
  - status による疑似的な再実行制御が可能

これらの一部は [README.md](https://github.com/gw31415/rusk-task/blob/8aa1e7fb1d748d820707e5fbf3229d387410cc58/README.md) にも記載しています。

自身は cargo-make ほど高機能になりすぎると手に余ります。task の設定の記載方法は好みではありませんでした。 just はシンプルで良いのですが、Makeのようなビルドシステム兼タスクランナーが欲しく、ビルドシステム部分も重要視しています。

最終的には、Make を自身のニーズに合わせてデフォルト設定を調整しブラッシュアップしたい、と言語化することができました。ということで、 “Simpler Make” を目指して開発を進めることにしました。

:::message
「デフォルト設定は悪」という人、許してください
:::

:::message
「Simpleを謳うプロジェクトは地雷」という人、許してください
:::

## 言語の選定

Rust が作者の好み(重要なファクター)というのはありますが、技術的な理由もあります。特に、クロスプラットフォームにおけるシェルに関してが決め手になりました。 `deno_task_shell` のように、多くの利用例があり、メンテナンスが安定しており、ライブラリとして用いやすいクロスプラットフォームシェルは少なかったです。

# 最後に

今後は新機能を考える前に、リリース自動化のためにCIを整えたり、1年のブランクで必要になったメンテナンスなどをしていきたいと思っています (クレートバージョンのBump upやDAG解決部分のロジックのリファクタなど)。新機能に関しては以下について考えたいとは思っていますが一旦後回しにします。

- 子孫ディレクトリの設定ファイルは探索しているが、先祖ディレクトリの設定ファイルは探した方が良いか否か
- タスクの引数をサポートするか否か

とはいえ、1年の期間を経た安定が得られ、十分実用的になっていると思います。よかったら使ってみてください。 `rusk-task` として [crates.io](https://crates.io/crates/rusk-task) にリリース済みです。

https://github.com/gw31415/rusk-task
